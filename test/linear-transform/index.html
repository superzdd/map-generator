<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>坐标变换</title>
		<style>
			* {
 				margin: 0;
 				padding: 0;
 				vertical-align: middle;
 			}
 		</style>
	</head>

	<body>
		<canvas id="cvs"></canvas>
		<img id="img" src="../../img/macao-full.png" alt="">
		<script type="text/javascript" src="../linear/axis.js"></script>
		<script>
			const SQRT_3 = Math.sqrt(3);
			const SQRT_3_3 = SQRT_3 / 3;
			const IMAGE_WIDTH = 1024;
			const IMAGE_HEIGHT = 1024;
			let appModel = {
				axisTickWidth: 25, // 坐标轴刻度步长
				axisTransform: {
					i: {
						x: 1,
						y: SQRT_3_3
					},
					j: {
						x: -1,
						y: SQRT_3_3
					},
				},
				canvasInfo: {
					width: 0,
					height: 0,
				},
				transformMatrix: {
					a: 0,
					b: 0,
					c: 0,
					d: 0
				},
				axisCenter: {
					x: 0,
					y: 0,
				}
			};

			let appController = {
				init: function() {
					appModel.canvasInfo.width = 2048;
					appModel.canvasInfo.height = 2048;
				},
				initAxisTransform: function() {
					appModel.axisTransform.i = {
						x: 2,
						y: 0
					};
					appModel.axisTransform.j = {
						x: 0,
						y: 1
					};
				},
				getModel() {
					return appModel;
				}
			};
			let appView = {
				canvas: document.getElementById('cvs'),
				ctx: null,
				axis: null,
				axisTransform: null,
				imgData: [],
				init: async function() {
					appView.initCanvas();
					appView.initAxisCenter();
					await appView.initImage();
					appView.initAxis();
					appView.initTransformAxis();
					appView.initTransformImage();
				},
				initCanvas: function() {
					const model = appController.getModel();
					appView.canvas.width = model.canvasInfo.width;
					appView.canvas.height = model.canvasInfo.height;

					appView.ctx = appView.canvas.getContext('2d');
					appView.ctx.rect(0, 0, model.canvasInfo.width, model.canvasInfo.height);
					appView.ctx.fillStyle = '#000000';
					appView.ctx.fill();
				},
				initAxisCenter() {
					const model = appController.getModel();
					model.axisCenter.x = 512;
					model.axisCenter.y = 512;
				},
				initAxis() {
					const model = appController.getModel();

					appView.axis = new axis(25, 25, model.axisTickWidth, appView.ctx, model.axisCenter);
					appView.axis.render();
				},
				initTransformAxis() {
					const model = appController.getModel();
					appView.axisTransform = new axis(25, 25, model.axisTickWidth, appView.ctx, {
						x: 2048 * 3 / 4,
						y: 2048 * 3 / 4
					}, model.axisTransform);
					appView.axisTransform.render();
				},
				initImage() {
					return new Promise((res, rej) => {
						let imgData = [];
						let imgDataTransformed = [];
						let img = document.getElementById('img');
						img.onload = function() {
							const center = appController.getModel().axisCenter;
							appView.ctx.drawImage(img, center.x - img.width / 2, center.y - img.height / 2);

							let sourceData = appView.ctx.getImageData(
									center.x - img.width / 2,
									center.y - img.height / 2,
									img.width,
									img.height)
								.data;

							for (let y = 0, index = 0; y < img.height; y++) {
								for (let x = 0; x < img.width; x++, index++) {
									let transformed = transform(x, y)
									let r = sourceData[index * 4]
									let g = sourceData[index * 4 + 1]
									let b = sourceData[index * 4 + 2]

									let color = `rgb(${r}, ${g}, ${b})`
									// cvsCtx.fillStyle = color;
									// cvsCtx.fillRect(transformed.x + origin.x, transformed.y + origin.y, 1, 1);

									appView.imgData.push({
										x: x,
										y: y,
										color: color
									});
									// imgDataTransformed.push({
									// 	x: transformed.x,
									// 	y: transformed.y,
									// 	color: color
									// })
								}
							}
							console.log(`init image complete`);
							res();
						}
					});
				},
				initTransformImage() {
					const imgData = appView.imgData;
					const tickWidth = appController.getModel().axisTickWidth;

					for (let i = 0; i < imgData.length; i++) {
						let x = i % IMAGE_WIDTH - IMAGE_WIDTH / 2;
						let y = IMAGE_WIDTH / 2 - Math.floor(i / IMAGE_WIDTH);
						console.log(`${JSON.stringify({x,y})}`);

						// let p = new point(x / tickWidth, y / tickWidth, appView.axisTransform);
						// p.render(appView.ctx, imgData[i].color);
					}
				},
			}

			appController.init();
			appView.init();

			function transform(x, y) {
				let _x = (x + (SQRT_3 * y)) / 2
				let _y = (SQRT_3 * y - x) / 2
				return {
					x: _x,
					y: _y
				}
			}

			function transformReverse(x, y) {
				let _x = x - y
				let _y = (SQRT_3 * (x + y)) / 3
				return {
					x: _x,
					y: _y
				}
			}
		</script>
	</body>

</html>
