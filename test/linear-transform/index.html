<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>坐标变换</title>
		<style>
			* {
                margin: 0;
                padding: 0;
                vertical-align: middle;
            }
			
			#cvs{
				width: 100vw;
			}
        </style>
	</head>

	<body>
		<canvas id="cvs"></canvas>
		<canvas id="cvs-transform"></canvas>
		<!-- <img id="img" src="../../img/macao-full.png" alt=""> -->
		<script type="text/javascript" src="../linear/axis.js"></script>
		<script>
			const SQRT_3 = Math.sqrt(3);
			const SQRT_3_3 = SQRT_3 / 3;
			const IMAGE_WIDTH = 2048;
			let appModel = {
				axisTickWidth: 25, // 坐标轴刻度步长
				axisTransform: {
					i: {
						x: 0.5,
						y: 0.5,
					},
					j: {
						x: -SQRT_3 * 0.5,
						y: SQRT_3 * 0.5,
					},
				},
				canvasInfo: {
					width: 0,
					height: 0,
				},
				transformMatrix: {
					a: 0,
					b: 0,
					c: 0,
					d: 0,
				},
			};

			let appController = {
				init: function() {
					appModel.canvasInfo.width = appModel.canvasInfo.height = IMAGE_WIDTH * 3;
				},
				getModel() {
					return appModel;
				},
			};
			let appView = {
				canvas: document.getElementById('cvs'),
				canvasTransform: document.getElementById('cvs-transform'),
				ctx: null,
				ctxTransform: null,
				axis: null,
				axisTransform: null,
				imgData: [],
				init: async function() {
					appView.initCanvas();
					appView.initAxis();
					appView.initTransformAxis();
					await appView.initImage();
					
					// 渲染坐标轴
					appView.axis.render();
					appView.axisTransform.render();
				},
				initCanvas: function() {
					const model = appController.getModel();
					appView.canvas.width = model.canvasInfo.width;
					appView.canvas.height = model.canvasInfo.height;

					appView.ctx = appView.canvas.getContext('2d');
					appView.ctx.rect(
						0,
						0,
						model.canvasInfo.width,
						model.canvasInfo.height
					);
					appView.ctx.fillStyle = '#000000';
					appView.ctx.fill();
				},
				initAxis() {
					const model = appController.getModel();
					appView.axis = new axis(
						50,
						50,
						model.axisTickWidth,
						appView.ctx, {
							x: IMAGE_WIDTH / 2,
							y: IMAGE_WIDTH / 2,
						}
					);
				},
				initTransformAxis() {
					const model = appController.getModel();
					appView.axisTransform = new axis(
						50,
						50,
						model.axisTickWidth,
						appView.ctx, {
							x: IMAGE_WIDTH * 1.5,
							y: IMAGE_WIDTH * 1.5,
						},
						model.axisTransform
					);
				},
				initImage() {
					return new Promise((res, rej) => {
						console.log(`init image start`);
						let imgData = [];
						let imgDataTransformed = [];
						let img = new Image();
						img.onload = function() {
							console.log(`init image loaded`);
							const center = appView.axis.center;
							appView.ctx.drawImage(
								img,
								center.x - img.width / 2,
								center.y - img.height / 2
							);

							let sourceData = appView.ctx.getImageData(
								center.x - img.width / 2,
								center.y - img.height / 2,
								img.width,
								img.height
							).data;

							for (let y = 0, index = 0; y < img.height; y++) {
								for (let x = 0; x < img.width; x++, index++) {
									let r = sourceData[index * 4];
									let g = sourceData[index * 4 + 1];
									let b = sourceData[index * 4 + 2];

									let color = `rgb(${r}, ${g}, ${b})`;

									appView.renderTransformPoint(index, color);
								}
							}
							console.log(`init image complete`);
							res();
						};
						img.src = '../../img/macao-all-2048.jpg';
					});
				},
				initTransformImage() {
					const imgData = appView.imgData;
					const tickWidth = appController.getModel().axisTickWidth;

					for (let i = 1; i <= imgData.length; i++) {
						let x = ((i - 1) % IMAGE_WIDTH) - IMAGE_WIDTH / 2;
						let y = -Math.floor((i - 1) / IMAGE_WIDTH) +
							IMAGE_WIDTH / 2;

						let p = new point(
							x / tickWidth,
							y / tickWidth,
							appView.axisTransform
						);
						p.render(appView.ctx, imgData[i].color);
					}
				},
				renderTransformPoint(index, color) {
					const tickWidth = appController.getModel().axisTickWidth;
					let x = ((index - 1) % IMAGE_WIDTH) - IMAGE_WIDTH / 2;
					let y = -Math.floor((index - 1) / IMAGE_WIDTH) +
						IMAGE_WIDTH / 2;
					let p = new point(
						x / tickWidth,
						y / tickWidth,
						appView.axisTransform
					);
					p.render(appView.ctx, color);
				},
			};

			appController.init();
			appView.init();
		</script>
	</body>
</html>
